============================= test session starts =============================
platform win32 -- Python 3.11.8, pytest-8.4.2, pluggy-1.6.0
rootdir: C:\Users\Usuario\Workspace\01_Proyectos\anclora-nexus\sdd\features\intelligence\tests\test-code
configfile: pytest.ini
plugins: anyio-4.11.0, langsmith-0.6.8, asyncio-1.2.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collected 25 items

sdd\features\intelligence\tests\test-code\test_skills.py FF.FFFF..FFF... [ 60%]
....F.....                                                               [100%]

================================== FAILURES ===================================
_________________________ test_lead_intake_happy_path _________________________
sdd\features\intelligence\tests\test-code\test_skills.py:25: in test_lead_intake_happy_path
    result = await run_lead_intake(data, mock_llm_service, mock_supabase_service)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\lead_intake.py:118: in run_lead_intake
    {validated_input.json(ensure_ascii=False)}
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\main.py:1317: in json
    raise TypeError('`dumps_kwargs` keyword arguments are no longer supported.')
E   TypeError: `dumps_kwargs` keyword arguments are no longer supported.
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.264454", "level": "INFO", "event_type": "skill_started", "skill": "lead_intake", "version": "1.0.0", "details": {"input_summary": "Juan Perez"}}
{"timestamp": "2026-02-13T20:43:35.270521", "level": "CRITICAL", "event_type": "skill_failed", "skill": "lead_intake", "version": "1.0.0", "details": {"error": "`dumps_kwargs` keyword arguments are no longer supported."}}
_______________________ test_lead_intake_high_priority ________________________
sdd\features\intelligence\tests\test-code\test_skills.py:42: in test_lead_intake_high_priority
    result = await run_lead_intake(data, mock_llm_service, mock_supabase_service)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\lead_intake.py:118: in run_lead_intake
    {validated_input.json(ensure_ascii=False)}
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\main.py:1317: in json
    raise TypeError('`dumps_kwargs` keyword arguments are no longer supported.')
E   TypeError: `dumps_kwargs` keyword arguments are no longer supported.
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.312085", "level": "INFO", "event_type": "skill_started", "skill": "lead_intake", "version": "1.0.0", "details": {"input_summary": "Rich Client"}}
{"timestamp": "2026-02-13T20:43:35.312085", "level": "CRITICAL", "event_type": "skill_failed", "skill": "lead_intake", "version": "1.0.0", "details": {"error": "`dumps_kwargs` keyword arguments are no longer supported."}}
_________________________ test_lead_intake_llm_retry __________________________
sdd\features\intelligence\tests\test-code\test_skills.py:60: in test_lead_intake_llm_retry
    result = await run_lead_intake(data, mock_llm_service, mock_supabase_service)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\lead_intake.py:118: in run_lead_intake
    {validated_input.json(ensure_ascii=False)}
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\main.py:1317: in json
    raise TypeError('`dumps_kwargs` keyword arguments are no longer supported.')
E   TypeError: `dumps_kwargs` keyword arguments are no longer supported.
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.536878", "level": "INFO", "event_type": "skill_started", "skill": "lead_intake", "version": "1.0.0", "details": {"input_summary": "Retry User"}}
{"timestamp": "2026-02-13T20:43:35.538620", "level": "CRITICAL", "event_type": "skill_failed", "skill": "lead_intake", "version": "1.0.0", "details": {"error": "`dumps_kwargs` keyword arguments are no longer supported."}}
____________________ test_lead_intake_llm_parsing_fallback ____________________
sdd\features\intelligence\tests\test-code\test_skills.py:71: in test_lead_intake_llm_parsing_fallback
    result = await run_lead_intake(data, mock_llm_service, mock_supabase_service)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\lead_intake.py:118: in run_lead_intake
    {validated_input.json(ensure_ascii=False)}
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\main.py:1317: in json
    raise TypeError('`dumps_kwargs` keyword arguments are no longer supported.')
E   TypeError: `dumps_kwargs` keyword arguments are no longer supported.
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.579077", "level": "INFO", "event_type": "skill_started", "skill": "lead_intake", "version": "1.0.0", "details": {"input_summary": "Parsing Fail"}}
{"timestamp": "2026-02-13T20:43:35.580149", "level": "CRITICAL", "event_type": "skill_failed", "skill": "lead_intake", "version": "1.0.0", "details": {"error": "`dumps_kwargs` keyword arguments are no longer supported."}}
__________________ test_lead_intake_copy_generation_fallback __________________
sdd\features\intelligence\tests\test-code\test_skills.py:83: in test_lead_intake_copy_generation_fallback
    result = await run_lead_intake(data, mock_llm_service, mock_supabase_service)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\lead_intake.py:118: in run_lead_intake
    {validated_input.json(ensure_ascii=False)}
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\main.py:1317: in json
    raise TypeError('`dumps_kwargs` keyword arguments are no longer supported.')
E   TypeError: `dumps_kwargs` keyword arguments are no longer supported.
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.620707", "level": "INFO", "event_type": "skill_started", "skill": "lead_intake", "version": "1.0.0", "details": {"input_summary": "Copy Fail"}}
{"timestamp": "2026-02-13T20:43:35.621376", "level": "CRITICAL", "event_type": "skill_failed", "skill": "lead_intake", "version": "1.0.0", "details": {"error": "`dumps_kwargs` keyword arguments are no longer supported."}}
_____________________ test_lead_intake_audit_log_payload ______________________
sdd\features\intelligence\tests\test-code\test_skills.py:92: in test_lead_intake_audit_log_payload
    await run_lead_intake(data, mock_llm_service, mock_supabase_service)
sdd\features\intelligence\skills\lead_intake.py:118: in run_lead_intake
    {validated_input.json(ensure_ascii=False)}
     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\main.py:1317: in json
    raise TypeError('`dumps_kwargs` keyword arguments are no longer supported.')
E   TypeError: `dumps_kwargs` keyword arguments are no longer supported.
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.660839", "level": "INFO", "event_type": "skill_started", "skill": "lead_intake", "version": "1.0.0", "details": {"input_summary": "Log Test"}}
{"timestamp": "2026-02-13T20:43:35.661354", "level": "CRITICAL", "event_type": "skill_failed", "skill": "lead_intake", "version": "1.0.0", "details": {"error": "`dumps_kwargs` keyword arguments are no longer supported."}}
__________________________ test_prospection_no_leads __________________________
sdd\features\intelligence\tests\test-code\test_skills.py:125: in test_prospection_no_leads
    assert "no_leads" in result["reason"].lower()
E   AssertionError: assert 'no_leads' in 'no active leads found with required priority.'
E    +  where 'no active leads found with required priority.' = <built-in method lower of str object at 0x00000169BFC6A2B0>()
E    +    where <built-in method lower of str object at 0x00000169BFC6A2B0> = 'No active leads found with required priority.'.lower
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.727483", "level": "INFO", "event_type": "skill_started", "skill": "prospection_weekly", "version": "1.0.0", "details": {"data": {}}}
{"timestamp": "2026-02-13T20:43:35.728152", "level": "INFO", "event_type": "prospection_skipped", "skill": "prospection_weekly", "version": "1.0.0", "details": {"reason": "no_leads"}}
_______________________ test_prospection_no_properties ________________________
sdd\features\intelligence\tests\test-code\test_skills.py:134: in test_prospection_no_properties
    assert "no_properties" in result["reason"].lower()
E   AssertionError: assert 'no_properties' in 'no available properties found for matching.'
E    +  where 'no available properties found for matching.' = <built-in method lower of str object at 0x00000169BFC69F50>()
E    +    where <built-in method lower of str object at 0x00000169BFC69F50> = 'No available properties found for matching.'.lower
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.745315", "level": "INFO", "event_type": "skill_started", "skill": "prospection_weekly", "version": "1.0.0", "details": {"data": {}}}
{"timestamp": "2026-02-13T20:43:35.745315", "level": "INFO", "event_type": "prospection_skipped", "skill": "prospection_weekly", "version": "1.0.0", "details": {"reason": "no_properties"}}
____________________ test_prospection_llm_timeout_fallback ____________________
sdd\features\intelligence\tests\test-code\test_skills.py:141: in test_prospection_llm_timeout_fallback
    result = await run_prospection_weekly({}, mock_llm_service, mock_supabase_service)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\prospection_weekly.py:134: in run_prospection_weekly
    matching_raw = await _call_llm_with_retry(llm.analyze, matching_prompt)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
sdd\features\intelligence\skills\prospection_weekly.py:69: in _call_llm_with_retry
    raise last_error
sdd\features\intelligence\skills\prospection_weekly.py:63: in _call_llm_with_retry
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:2237: in _execute_mock_call
    raise effect
sdd\features\intelligence\skills\prospection_weekly.py:63: in _call_llm_with_retry
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:2237: in _execute_mock_call
    raise effect
sdd\features\intelligence\skills\prospection_weekly.py:63: in _call_llm_with_retry
    return await func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:2237: in _execute_mock_call
    raise effect
E   Exception: LLM Timeout
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:35.766327", "level": "INFO", "event_type": "skill_started", "skill": "prospection_weekly", "version": "1.0.0", "details": {"data": {}}}
{"timestamp": "2026-02-13T20:43:35.767395", "level": "WARNING", "event_type": "llm_retry", "skill": "prospection_weekly", "version": "1.0.0", "details": {"attempt": 1, "error": "LLM Timeout"}}
{"timestamp": "2026-02-13T20:43:36.273119", "level": "WARNING", "event_type": "llm_retry", "skill": "prospection_weekly", "version": "1.0.0", "details": {"attempt": 2, "error": "LLM Timeout"}}
{"timestamp": "2026-02-13T20:43:37.281137", "level": "WARNING", "event_type": "llm_retry", "skill": "prospection_weekly", "version": "1.0.0", "details": {"attempt": 3, "error": "LLM Timeout"}}
{"timestamp": "2026-02-13T20:43:39.289460", "level": "CRITICAL", "event_type": "skill_failed", "skill": "prospection_weekly", "version": "1.0.0", "details": {"error": "LLM Timeout"}}
___________________________ test_recap_llm_fallback ___________________________
sdd\features\intelligence\tests\test-code\test_skills.py:224: in test_recap_llm_fallback
    assert "Normalidad" in result["luxury_summary"]
E   AssertionError: assert 'Normalidad' in 'Resumen semanal de Anclora Nexus: Actividad estable en la zona suroeste. Los sistemas de prospecci�n y gesti�n de leads operan con normalidad.'
---------------------------- Captured stdout call -----------------------------
{"timestamp": "2026-02-13T20:43:39.740238", "level": "INFO", "event_type": "skill_started", "skill": "recap_weekly", "version": "1.0.0", "details": {"data": {}}}
{"timestamp": "2026-02-13T20:43:39.740238", "level": "DEBUG", "event_type": "data_collection_started", "skill": "recap_weekly", "version": "1.0.0", "details": {"days": 7}}
{"timestamp": "2026-02-13T20:43:39.740238", "level": "WARNING", "event_type": "recap_parsing_failed", "skill": "recap_weekly", "version": "1.0.0", "details": {"error": "Expecting value: line 1 column 1 (char 0)"}}
{"timestamp": "2026-02-13T20:43:39.740238", "level": "INFO", "event_type": "skill_completed", "skill": "recap_weekly", "version": "1.0.0", "details": {"new_leads": 0, "duration_ms": 0.0}}
============================== warnings summary ===============================
backend\intelligence\models.py:16
  C:\Users\Usuario\Workspace\01_Proyectos\anclora-nexus\backend\intelligence\models.py:16: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\config\__init__.py:1474
  C:\Users\Usuario\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\config\__init__.py:1474: PytestConfigWarning: Unknown config option: env
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

test_skills.py::test_lead_intake_happy_path
test_skills.py::test_lead_intake_high_priority
test_skills.py::test_lead_intake_llm_retry
test_skills.py::test_lead_intake_llm_parsing_fallback
test_skills.py::test_lead_intake_copy_generation_fallback
test_skills.py::test_lead_intake_audit_log_payload
test_skills.py::test_lead_intake_critical_failure
  C:\Users\Usuario\Workspace\01_Proyectos\anclora-nexus\sdd\features\intelligence\skills\lead_intake.py:118: PydanticDeprecatedSince20: The `json` method is deprecated; use `model_dump_json` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    {validated_input.json(ensure_ascii=False)}

test_skills.py::test_prospection_happy_path
test_skills.py::test_prospection_complex_matching
test_skills.py::test_prospection_complex_matching
  C:\Users\Usuario\Workspace\01_Proyectos\anclora-nexus\sdd\features\intelligence\skills\prospection_weekly.py:155: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    {json.dumps([m.dict() for m in matchings], ensure_ascii=False)}

test_skills.py::test_prospection_happy_path
test_skills.py::test_prospection_matching_parsing_error
test_skills.py::test_prospection_complex_matching
test_skills.py::test_prospection_supabase_call
  C:\Users\Usuario\Workspace\01_Proyectos\anclora-nexus\sdd\features\intelligence\skills\prospection_weekly.py:177: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    return result.dict()

test_skills.py::test_recap_happy_path
test_skills.py::test_recap_empty_data
test_skills.py::test_recap_db_failure_graceful
test_skills.py::test_recap_llm_fallback
test_skills.py::test_recap_high_priority_highlight
test_skills.py::test_recap_execution_metric_calc
test_skills.py::test_recap_duration_logging
  C:\Users\Usuario\Workspace\01_Proyectos\anclora-nexus\sdd\features\intelligence\skills\recap_weekly.py:185: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    return result.dict()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_lead_intake_happy_path
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_lead_intake_high_priority
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_lead_intake_llm_retry
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_lead_intake_llm_parsing_fallback
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_lead_intake_copy_generation_fallback
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_lead_intake_audit_log_payload
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_prospection_no_leads
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_prospection_no_properties
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_prospection_llm_timeout_fallback
FAILED sdd\features\intelligence\tests\test-code\test_skills.py::test_recap_llm_fallback
================= 10 failed, 15 passed, 23 warnings in 16.28s =================
