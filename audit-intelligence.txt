═══════════════════════════════════════════════════════════════════════════════
        AUDITORÍA: INTELLIGENCE FEATURE - ESTADO ACTUAL VS SDD
═══════════════════════════════════════════════════════════════════════════════

FECHA: 2026-02-13
OBJETIVO: Identificar desalineaciones entre estructura actual y SDD esperada
ACCIÓN: Refactor limpio a patrón SDD correcto

═══════════════════════════════════════════════════════════════════════════════
1. ESTRUCTURA ACTUAL vs ESPERADA
═══════════════════════════════════════════════════════════════════════════════

✓ EXISTE - backend/intelligence/
  ├── __init__.py
  ├── database.py
  ├── models.py
  ├── types.py
  ├── validation.py
  ├── components/
  │   ├── governor.py
  │   ├── router.py
  │   └── synthesizer.py
  ├── orchestrator/
  │   └── orchestrator.py
  └── tests/
      └── test_orchestrator.py

⚠ PROBLEMA 1: backend/skills/ EXISTE (incorrecto)
  ├── __init__.py
  ├── lead_intake.py           ← DEBERÍA estar en .sdd/features/intelligence/
  ├── prospection_weekly.py    ← DEBERÍA estar en .sdd/features/intelligence/
  └── recap_weekly.py          ← DEBERÍA estar en .sdd/features/intelligence/

✓ EXISTE - intelligence-engine/ (raíz)
  ├── contracts/
  │   ├── contract-01-governor-decision-schema-v1.md
  │   ├── contract-02-query-plan-schema-v1.md
  │   ├── contract-03-synthesizer-output-schema-v1.md
  │   ├── contract-04-strategic-mode-schema-v1.md
  │   ├── contract-05-audit-log-schema-v1.md
  │   └── contract-06-notebooklm-retrieval-policy-v1.md
  ├── domain-packs/        ← VACÍO (debería tener content)
  └── governance/          ← VACÍO (debería tener content)

⚠ PROBLEMA 2: backend/intelligence-engine/ EXISTE pero VACÍO
  ├── contracts/           ← VACÍO (debería sincronizar con raíz)
  ├── domain-packs/       ← VACÍO
  └── governance/         ← VACÍO

✓ EXISTE - .sdd/features/intelligence/
  ├── INDEX.md
  └── spec-intelligence-v1.md

✓ EXISTE - .agent/rules/
  └── feature-intelligence.md

✓ EXISTE - .agent/skills/features/intelligence/
  └── SKILL.md

⚠ PROBLEMA 3: .antigravity/prompts/ INCOMPLETO
  └── SIN feature-intelligence.md prompt (SÍ existe feature-multitenant-v1.md)

═══════════════════════════════════════════════════════════════════════════════
2. ANÁLISIS DETALLADO POR COMPONENTE
═══════════════════════════════════════════════════════════════════════════════

COMPONENTE: Skills (lead_intake, prospection_weekly, recap_weekly)
────────────────────────────────────────────────────────────────────────────────

UBICACIÓN ACTUAL: backend/skills/
UBICACIÓN CORRECTA: .sdd/features/intelligence/skills/

ANÁLISIS DE CÓDIGO:
  • lead_intake.py
    - Depende: LLMService, SupabaseService
    - Función: run_lead_intake() → JSON con análisis/prioridad
    - Deuda técnica: Error handling débil (try/except genérico)
    - Mejora: Validar schema input, type hints más estrictos
    
  • prospection_weekly.py
    - Depende: LLMService, SupabaseService
    - Función: run_prospection_weekly() → Matching leads-properties
    - Deuda técnica: Parsing JSON frágil, sin validación Pydantic
    - Mejora: Usar Pydantic models para response parsing
    
  • recap_weekly.py
    - Depende: LLMService, SupabaseService
    - Función: run_recap_weekly() → Executive summary
    - Deuda técnica: Fallback hardcodeado sin logging
    - Mejora: Structured logging, retry logic

IMPACTO: 3 skills operativos pero ubicación incorrecta + deuda técnica

═══════════════════════════════════════════════════════════════════════════════
3. MAPEO: CÓDIGO ACTUAL → ESTRUCTURA SDD
═══════════════════════════════════════════════════════════════════════════════

BACKEND/INTELLIGENCE COMPONENTS:
──────────────────────────────────────────────────────────────────────────────
backend/intelligence/components/governor.py
  ├── Propósito: Decision making component
  └─→ DEBE mapear a: .sdd/features/intelligence/domain-packs/governor/

backend/intelligence/components/router.py
  ├── Propósito: Query routing component
  └─→ DEBE mapear a: .sdd/features/intelligence/domain-packs/router/

backend/intelligence/components/synthesizer.py
  ├── Propósito: Output synthesis component
  └─→ DEBE mapear a: .sdd/features/intelligence/domain-packs/synthesizer/

backend/intelligence/orchestrator/orchestrator.py
  ├── Propósito: Orquestar flujo completo
  └─→ DEBE mapear a: .sdd/features/intelligence/orchestrator/

BACKEND/SKILLS:
──────────────────────────────────────────────────────────────────────────────
backend/skills/lead_intake.py
  ├── Propósito: Skill para intake de leads
  └─→ DEBE mover a: .sdd/features/intelligence/skills/lead_intake.py

backend/skills/prospection_weekly.py
  ├── Propósito: Skill para prospección semanal
  └─→ DEBE mover a: .sdd/features/intelligence/skills/prospection_weekly.py

backend/skills/recap_weekly.py
  ├── Propósito: Skill para recap ejecutivo
  └─→ DEBE mover a: .sdd/features/intelligence/skills/recap_weekly.py

INTELLIGENCE-ENGINE (RAÍZ):
──────────────────────────────────────────────────────────────────────────────
intelligence-engine/contracts/*.md
  ├── 6 contracts definidos (governor, query-plan, synthesizer, etc)
  └─→ DEBE sincronizar a: .sdd/features/intelligence/contracts/

intelligence-engine/domain-packs/ (VACÍO)
  └─→ DEBE llenar con: Implementación de domain-packs (refactored)

intelligence-engine/governance/ (VACÍO)
  └─→ DEBE llenar con: Governance rules + audit patterns

═══════════════════════════════════════════════════════════════════════════════
4. ESTADO DEL SDD INTELLIGENCE ACTUAL
═══════════════════════════════════════════════════════════════════════════════

.sdd/features/intelligence/INDEX.md
  Status: EXISTS
  Content: Navigation hub para intelligence feature
  Validación: ¿Referencia correctamente SKILL.md, spec, rules?
  
.sdd/features/intelligence/spec-intelligence-v1.md
  Status: EXISTS
  Content: Technical specification completa
  Validación: ¿Incluye skills (lead_intake, prospection, recap)?
  
.agent/rules/feature-intelligence.md
  Status: EXISTS
  Content: Rules y governance para feature
  Validación: ¿Cubre validaciones + constraints?

.agent/skills/features/intelligence/SKILL.md
  Status: EXISTS
  Content: Development methods para intelligence
  Validación: ¿Incluye métodos para los 3 skills?

.antigravity/prompts/feature-intelligence.md
  Status: ⚠ FALTA O INCOMPLETO
  Content: SHOULD BE - Antigravity prompt para generar feature
  Impacto: Sin este prompt, no se puede regenerar inteligencia con Antigravity

═══════════════════════════════════════════════════════════════════════════════
5. DESALINEACIONES CRÍTICAS IDENTIFICADAS
═══════════════════════════════════════════════════════════════════════════════

DESALINEACIÓN #1: Skills en ubicación incorrecta
  Ubicación actual: backend/skills/
  Ubicación correcta: .sdd/features/intelligence/skills/
  Impacto: Incompatible con estructura SDD
  Severidad: ALTA
  
DESALINEACIÓN #2: intelligence-engine vacío en raíz
  Ubicación: intelligence-engine/domain-packs/, intelligence-engine/governance/
  Problema: Carpetas existen pero vacías
  Debería contener: Implementación de domain-packs + governance logic
  Severidad: MEDIA (estructura existe pero sin contenido)

DESALINEACIÓN #3: backend/intelligence-engine duplicado vacío
  Ubicación: backend/intelligence-engine/
  Problema: Duplicate de raíz pero sin contenido
  Debería: Sincronizar o eliminar
  Severidad: MEDIA (confusión de estructura)

DESALINEACIÓN #4: Prompt Antigravity faltante
  Ubicación: .antigravity/prompts/
  Falta: feature-intelligence.md (prompt generación)
  Impacto: No se puede regenerar feature via Antigravity
  Severidad: ALTA (bloqueador para refactor futuro)

DESALINEACIÓN #5: Código con deuda técnica
  Ubicaciones: backend/skills/*.py
  Problemas:
    - Error handling débil (try/except genérico)
    - Parsing JSON frágil
    - Sin validación Pydantic
    - Sin logging estructurado
  Severidad: MEDIA (funcional pero mantenible)

═══════════════════════════════════════════════════════════════════════════════
6. ARCHIVOS QUE REQUIEREN REVISIÓN/REFACTOR
═══════════════════════════════════════════════════════════════════════════════

CAMBIOS NECESARIOS EN SDD EXISTENTE:

1. .sdd/features/intelligence/INDEX.md
   ☐ Actualizar referencias a SKILL.md
   ☐ Agregar sección "Skills" con lista (lead_intake, prospection, recap)
   ☐ Incluir diagrama de flujo orchestrator
   ☐ Documentar contracts mapping

2. .sdd/features/intelligence/spec-intelligence-v1.md
   ☐ Agregar sección "Skills Specification" (3 skills detallados)
   ☐ Definir interfaz para cada skill (input/output schema)
   ☐ Incluir error handling requirements
   ☐ Documentar deuda técnica actual + plan refactor

3. .agent/rules/feature-intelligence.md
   ☐ Validaciones para skills (input schema, output schema)
   ☐ Rules de orchestration
   ☐ Error handling rules
   ☐ Logging requirements

4. .agent/skills/features/intelligence/SKILL.md
   ☐ Agregar métodos para cada skill (run_lead_intake, run_prospection, run_recap)
   ☐ Implementar_skill pattern (cómo generar skill)
   ☐ Validación y testing patterns

ARCHIVOS NUEVOS A GENERAR:

5. .antigravity/prompts/feature-intelligence.md
   ☐ Prompt completo para Antigravity
   ☐ Artefactos a generar (3 skills refactoreados)
   ☐ Criterios de aceptación
   ☐ Testing requirements

6. .sdd/features/intelligence/skills-specification.md (NUEVO)
   ☐ Spec detallada de los 3 skills
   ☐ Input/output schemas (Pydantic)
   ☐ Error handling
   ☐ Logging patterns

7. intelligence-engine/domain-packs/README.md (NUEVO)
   ☐ Documentación de domain-packs
   ☐ Patrones de implementación
   ☐ Guía de extensibilidad

8. intelligence-engine/governance/AUDIT-LOG-SCHEMA.md (NUEVO)
   ☐ Audit logging strategy
   ☐ Governance rules
   ☐ Compliance requirements

═══════════════════════════════════════════════════════════════════════════════
7. PLAN DE REFACTOR (Alto nivel)
═══════════════════════════════════════════════════════════════════════════════

FASE 1: Preparación (antes de mover código)
  ☐ Crear estructura SDD completa (carpetas nuevas)
  ☐ Generar prompts Antigravity
  ☐ Documentar nuevas specs

FASE 2: Refactor de Código (limpieza técnica)
  ☐ Actualizar backend/skills/*.py con mejoras
    - Validación Pydantic
    - Error handling robusto
    - Logging estructurado
    - Type hints completos
  
FASE 3: Migración a SDD (mover archivos)
  ☐ Mover refactored skills a .sdd/features/intelligence/skills/
  ☐ Mover orchestrator a .sdd/features/intelligence/orchestrator/
  ☐ Sincronizar intelligence-engine/contracts con .sdd/
  ☐ Documentar extractibilidad

FASE 4: Alineación (actualizar referencias)
  ☐ Actualizar imports en backend/api/routes/intelligence.py
  ☐ Actualizar tests
  ☐ Deprecate backend/skills/ (marcar como deprecated)
  ☐ Validar E2E

═══════════════════════════════════════════════════════════════════════════════
8. RESUMEN EJECUTIVO
═══════════════════════════════════════════════════════════════════════════════

ESTADO ACTUAL:
  • Intelligence FUNCIONAL pero DESALINEADA con SDD
  • Código operativo con deuda técnica acumulada
  • Estructura SDD parcialmente creada (INDEX.md, spec-v1.md)
  • Skills en ubicación INCORRECTA (backend/skills/)
  
PROBLEMAS CRÍTICOS:
  1. Skills ubicación incorrecta
  2. Falta Antigravity prompt
  3. intelligence-engine/ vacío en raíz
  4. Código con deuda técnica
  
SCOPE DE REFACTOR:
  • 8 archivos SDD a crear/actualizar
  • 3 skills a refactorear + mover
  • 5 archivos backend a actualizar
  • Documentación de extractibilidad
  
TIMELINE ESTIMADO:
  • Auditoría: COMPLETADA
  • Plan detallado: 2-3 horas
  • Refactor código: 2-3 horas
  • Migración SDD: 1-2 horas
  • Validación E2E: 1 hora
  • TOTAL: 6-9 horas (pueden ser paralelo a Multi-Tenant)

═══════════════════════════════════════════════════════════════════════════════

READY PARA: Plan detallado de refactor + SDD actualizado + code refactoreado

